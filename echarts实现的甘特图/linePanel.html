<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>线边看板</title>
    <meta name="viewport" content="width=device-width" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link href="bootstrap/css/bootstrap.css" rel="stylesheet" />
    <link href="linePanel.css" rel="stylesheet" />
</head>

<body>
    <div class="container-fluid">
        <div class="linePanel" id="linePanel" v-cloak>
            <div class="linePanel-item">
                <h2 class="page-title darkBlue">
                    <span class="tab-tit" v-for="(item,index) in linePanelTitle" @click="changeTab(index,item.code)"
                          :class="{active:cur==index}">
                        {{ item.name + '[' + item.code + ']' }}
                    </span>
                    <span class="currentDate">{{currentDate}}</span>
                </h2>
                <div class="tab-content">
                    <div class="row " v-if="linePanelDetail.title">
                        <div class="col-md-3">
                            <div class="card gradient-1">
                                <div class="card-body ">
                                    <h4 class="card-title">今日工单</h4>
                                    <div class="card-content">
                                        <div class="produce pd_t15">
                                            <div class="produce-item">
                                                <div class="produce-type">计划</div>
                                                <!-- <div>
                                                  <span class="oval"></span>
                                                </div> -->
                                                <div class="produce-progress" :style="{'width': linePanelDetail.title.wocount>0?'65%':'0%'}">
                                                    <div class="progress" style="height:10px">
                                                        <div class="progress-bar" style="width:100%;background-color: #fff;"></div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">
                                                    {{ linePanelDetail.title.wocount }}
                                                </div>
                                            </div>

                                            <div class="produce-item">
                                                <div class="produce-type">实际</div>
                                                <!-- <div>
                                                  <span class="round"></span>
                                                </div> -->
                                                <div class="produce-progress" :style="{'width': wocountWidth}">
                                                    <div class="progress" style="height:10px">
                                                        <div class="progress-bar" style="width:100%;background-color: #fff;"></div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">{{ linePanelDetail.title.wocount_ac }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card gradient-2">
                                <div class="card-body ">
                                    <h4 class="card-title">产品数量</h4>
                                    <div class="card-content">
                                        <div class="produce pd_t15">
                                            <div class="produce-item">
                                                <div class="produce-type">计划</div>
                                                <!-- <div>
                                                  <span class="oval"></span>
                                                </div> -->
                                                <div class="produce-progress" :style="{'width': linePanelDetail.title.qty>0?'65%':'0%'}">
                                                    <div class="progress" style="height:10px;">
                                                        <div class="progress-bar" style="background-color: #fff;"></div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">{{ linePanelDetail.title.qty }}</div>
                                            </div>

                                            <div class="produce-item">
                                                <div class="produce-type">实际</div>
                                                <!-- <div>
                                                  <span class="round"></span>
                                                </div> -->
                                                <div class="produce-progress" :style="{'width':qtyWidth}">
                                                    <div class="progress" style="height:10px">
                                                        <div class="progress-bar" style="width:100%;background-color: #fff;">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">{{ linePanelDetail.title.qty_ac }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card gradient-3">
                                <div class="card-body ">
                                    <h4 class="card-title">工时</h4>
                                    <div class="card-content" v-if="linePanelDetail.title.totalHour>=linePanelDetail.title.totalHour_ac">
                                        <div class="produce pd_t15">
                                            <div class="produce-item">
                                                <div class="produce-type">计划</div>
                                                <!-- <div>
                                                  <span class="oval"></span>
                                                </div> -->
                                                <div class="produce-progress" :style="{'width': linePanelDetail.title.totalHour>0?'65%':'0%'}">
                                                    <div class="progress" style="height:10px">
                                                        <div class="progress-bar" style="background-color: #fff;"></div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">
                                                    {{linePanelDetail.title.totalHour}}h
                                                </div>
                                            </div>

                                            <div class="produce-item">
                                                <div class="produce-type">实际</div>
                                                <!-- <div>
                                                  <span class="round"></span>
                                                </div> -->
                                                <div class="produce-progress" :style="{ 'width': totalHourWidth}">
                                                    <div class="progress" style="height:10px;">
                                                        <div class="progress-bar" style="background-color: #fff;"></div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">{{linePanelDetail.title.totalHour_ac}}h</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-content" v-else>
                                        <div class="produce pd_t15">
                                            <div class="produce-item">
                                                <div class="produce-type">计划</div>
                                                <!-- <div>
                                                    <span class="oval"></span>
                                                  </div> -->
                                                <div class="produce-progress" :style="{ 'width': totalHourWidth}">
                                                    <div class="progress" style="height:10px">
                                                        <div class="progress-bar" style="background-color: #fff;"></div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">
                                                    {{linePanelDetail.title.totalHour}}h
                                                </div>
                                            </div>

                                            <div class="produce-item">
                                                <div class="produce-type">实际</div>
                                                <!-- <div>
                                                    <span class="round"></span>
                                                  </div> -->
                                                <div class="produce-progress" :style="{'width': linePanelDetail.title.totalHour_ac?'65%':'0%'}">
                                                    <div class="progress" style="height:10px;">
                                                        <div class="progress-bar" style="background-color: #fff;"></div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">{{linePanelDetail.title.totalHour_ac}}h</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card gradient-4">
                                <div class="card-body ">
                                    <h4 class="card-title">完成进度</h4>
                                    <div class="card-content">
                                        <div class="produce">
                                            <div class="produce-item">
                                                <div class="produce-type">工单</div>
                                                <div class="produce-progress">
                                                    <div class="progress" style="height:10px">
                                                        <div class="progress-bar" :style="{ 'width': wocountPersent}">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">
                                                    {{wocountPersent}}
                                                </div>
                                            </div>
                                            <div class="produce-item">
                                                <div class="produce-type">产品</div>
                                                <div class="produce-progress">
                                                    <div class="progress" style="height:10px">
                                                        <div class="progress-bar" :style="{ 'width': qtyPersent}">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">
                                                    {{qtyPersent}}
                                                </div>
                                            </div>
                                            <div class="produce-item">
                                                <div class="produce-type">工时</div>
                                                <div class="produce-progress">
                                                    <div class="progress" style="height:10px">
                                                        <div class="progress-bar" :style="{ 'width': totalHourPersent >= 100 ? '100%' : totalHourPersent + '%'}"></div>
                                                    </div>
                                                </div>
                                                <div class="produce-num">
                                                    {{totalHourPersent}}%
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="linePanel-item">
                        <h3 class="page-title darkBlue">生产计划</h3>
                        <div id="myChart" ref="myChart" v-bind:style="{'width': '100%', 'height': (graphicHeight + 10 + (heightNum * 50)) + 'px'}"></div>
                        <div class="linePanel-table" v-if="linePanelDetail.details">
                            <div class="table-responsive ">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>工单号</th>
                                            <th>物料</th>
                                            <th>交付日期</th>
                                            <th>开始时间</th>
                                            <th>结束时间</th>
                                            <th>计划数量</th>
                                            <th>已产数量</th>
                                            <th>计划工时</th>
                                            <th>实际工时</th>
                                            <th>状态</th>
                                            <th>是否超时</th>
                                            <th>备注</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="item in linePanelDetail.details" :class="item.IsOutTime?'overTimeColor':''">
                                            <td>{{ item.WO }}</td>
                                            <td>{{ item.Stock }}</td>
                                            <td>{{ item.PlanDate }}</td>
                                            <td>{{ item.BeginTime }}</td>
                                            <td>{{ item.EndTime }}</td>
                                            <td>{{ item.PlanQty }}</td>
                                            <td>{{ item.AcQty }}</td>
                                            <td>{{ item.PlanHour }}</td>
                                            <td>{{ item.AcHour }}</td>
                                            <td>{{ item.Status }}</td>
                                            <td>{{ item.IsOutTime ? '已超时' : '未超时' }}</td>
                                            <td>{{ item.Remark }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="jquery/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="Vue/vue.js"></script>
    <script src="ECharts/echarts.js"></script>
    <!-- <script src="moment/moment.min.js"></script> -->
    <script>
        window.onload = function () {
            var vm = new Vue({
                el: '#linePanel',
                data: {
                    linePanelTitle: [], //线边看板标题
                    linePanelDetail: {}, //线边看板信息
                    myCharts: null, // eharts
                    progessAc: [], // 实际
                    progessPlan: [], // 计划
                    pauseReason: [], // 暂停原因
                    cur: 0, // 默认显示第一个
                    // currentDate: moment().format("YYYY-MM-DD"),
                    wocountWidth: '',
                    qtyWidth: '',
                    totalHourWidth: '',
                    wocountPersent: '',
                    qtyPersent: '',
                    totalHourPersent: '',
                    heightNum: 10,
                    graphicHeight: 0
                },
                methods: {
                    getlinePanelInfo: function (code) {
                        var self = this;
                        this.myChart && this.myChart.clear();
                        // $.ajax({
                        //     type: 'POST',
                        //     url: '/home/productingdatanew',
                        //     data: {
                        //         workcenter: code ? code : '',
                        //     },
                        //     dataType: 'json',
                        //     success: function (data) {
                                self.linePanelTitle = data.WC;
                                for (var i = 0; i < data.WC.length; i++) {
                                    if (data.WC[i].code == code) {
                                        self.cur = i;
                                    }
                                }
                                self.linePanelDetail = data.Detail;
                                self.progessAc = data.Detail.progessAc;
                                self.progessPlan = data.Detail.progessPlan;
                                self.pauseReason = data.Detail.pauseReason;
                                self.wocountPersent = self.getPresent(self.linePanelDetail.title.wocount_ac, self
                                    .linePanelDetail.title.wocount, 100);
                                self.qtyPersent = self.getPresent(self.linePanelDetail.title.qty_ac, self.linePanelDetail
                                    .title
                                    .qty, 100);
                                self.totalHourPersent = self.getProgress(self.linePanelDetail.title.totalHour_ac, self
                                    .linePanelDetail.title.totalHour);
                                    
                                self.wocountWidth = self.getPresent(self.linePanelDetail.title.wocount_ac, self
                                    .linePanelDetail.title.wocount, 65);
                                self.qtyWidth = self.getPresent(self.linePanelDetail.title.qty_ac, self.linePanelDetail
                                    .title
                                    .qty, 65);
                                self.totalHourWidth = self.getPresent(self.linePanelDetail.title.totalHour_ac, self
                                    .linePanelDetail.title.totalHour, 65);

                                self.$nextTick(function () {
                                    if (data.Detail.progessPlan.length > 0) {
                                        self.renderEcharts(data);
                                    } else {
                                        self.myChart && self.myChart.clear();
                                    }

                                    // self.myCharts && self.myCharts.resize()
                                })
                        //     }
                        // })
                    },
                    changeTab: function (index, code) {
                        this.cur = index;
                        this.getlinePanelInfo(code)
                    },
                    getProgress: function (reality, plan) {
                      if (plan) {
                        var precent = reality / plan;
                        precent && (precent = ((reality / plan) * 100).toFixed(2));
                        return precent
                      } else {
                         return 0
                      }
                    },
                    getPresent: function (plan, reality, num) {
                        if (reality == 0) {
                            reality = 1
                        }
                        if (plan > reality) {
                            return ((reality / plan) * num).toFixed(2) + "%"

                        } else {
                            return ((plan / reality) * num).toFixed(2) + "%"
                        }
                    },
                    renderEcharts: function (data) {
                        var startHour = Number(data.Detail.bc_begin.split(':')[0]);
                        var startMinute = Number(data.Detail.bc_begin.split(':')[1]);
                        var myChart = document.getElementById('myChart');

                        var clorReverse = function (OldColorValue){
                          var OldColorValue="0x"+OldColorValue.replace(/#/g,"");
                          var str="000000"+(0xFFFFFF-OldColorValue).toString(16);
                          return '#' + str.substring(str.length-6,str.length);
                        };
                        var toMinute = function (string) {
                            var array = string.split(':');
                            var hour = Number(array[0]);
                            var minute = Number(array[1]);
                            return hour * 60 + minute;
                        };
                        var toMinuStr = function (num) {
                            var hour = Math.floor(num / 60);
                            var minute = num % 60;
                            hour = hour > 9 ? hour : '0' + hour;
                            minute = minute > 9 ? minute : '0' + minute;
                            return hour + ':' + minute;
                        };
                        var getProgessAc = function () {
                            var outArray = [];
                            var index = 0;
                            var innerArray = [];
                            var progessAc = data.Detail.progessAc;

                            var getPauseList = function (acItem) {
                              var array = [];
                              if (acItem.pauseList.length > 0) {
                                acItem.pauseList.forEach(function (item, index) {
                                  switch (index) {
                                    case 0:
                                        var arr = [{
                                            begin: acItem.begin,
                                            end: item.begin,
                                            color: acItem.color,
                                            qty: acItem.qty,
                                            pauseList: []
                                        },{
                                            begin: item.begin,
                                            end: item.end,
                                            color: item.color,
                                            qty: item.code,
                                            pauseList: []
                                        }];
                                        if (acItem.pauseList.length == 1) {
                                          arr.push({
                                            begin: item.end,
                                            end: acItem.end,
                                            color: acItem.color,
                                            qty: acItem.qty,
                                            pauseList: []
                                          })
                                        }
                                        array = array.concat(arr);
                                      break;
                                    case (acItem.pauseList.length - 1):
                                        if (acItem.pauseList.length > 1) {
                                            if (item.begin < acItem.pauseList[index - 1].end) {
                                              array[array.length - 1].end = item.begin;
                                            };
                                            var arr = [{
                                                begin: item.begin,
                                                end: item.end,
                                                color: item.color,
                                                qty: item.code,
                                                pauseList: []
                                            },{
                                                begin: item.end,
                                                end: acItem.end,
                                                color: acItem.color,
                                                qty: acItem.qty,
                                                pauseList: []
                                            }];
                                            array = array.concat(arr);
                                        };
                                      break;
                                    default:
                                      if (item.begin < acItem.pauseList[index - 1].end) {
                                        array[array.length - 1].end = item.begin;
                                        var arr = [{
                                            begin: item.begin,
                                            end: item.end,
                                            color: item.color,
                                            qty: item.code,
                                            pauseList: []
                                        }];
                                        if (item.end < acItem.pauseList[index + 1].begin) {
                                          arr.push({
                                            begin: item.end,
                                            end: acItem.pauseList[index + 1].begin,
                                            color: acItem.color,
                                            qty: acItem.qty,
                                            pauseList: []
                                          })
                                        };
                                        array = array.concat(arr);
                                      } else {
                                        var arr = [{
                                            begin: item.begin,
                                            end: item.end,
                                            color: item.color,
                                            qty: item.code,
                                            pauseList: []
                                        }];
                                        if (item.end < acItem.pauseList[index + 1].begin) {
                                          arr.push({
                                            begin: item.end,
                                            end: acItem.pauseList[index + 1].begin,
                                            color: acItem.color,
                                            qty: acItem.qty,
                                            pauseList: []
                                          })
                                        };
                                        array = array.concat(arr);
                                      };
                                      break;
                                  };
                                });
                                console.log(array)
                                return array;
                              } else {
                                  return acItem
                              };
                            };

                            if (toMinute(data.Detail.bc_begin) < toMinute(progessAc[0].begin)) {
                                innerArray.push({
                                    begin: data.Detail.bc_begin,
                                    end: progessAc[0].begin,
                                    isOpacity: true
                                });
                            };

                            if (progessAc.length == 1) {
                                // innerArray.push(progessAc[index]);
                                innerArray = innerArray.concat(getPauseList(progessAc[index]));
                                outArray.push(innerArray);
                                return outArray;
                            } else {
                                for (index; index < progessAc.length; index++) {
                                    if (index == 0) {
                                        if (progessAc.length == 1) {
                                            // innerArray.push(progessAc[index]);
                                            innerArray = innerArray.concat(getPauseList(progessAc[index]));
                                            outArray.push(innerArray);
                                        } else {
                                          innerArray = innerArray.concat(getPauseList(progessAc[index]));
                                        };
                                    } else if (index < progessAc.length - 1) {
                                        if (toMinute(progessAc[index].begin) < toMinute(progessAc[index - 1].end)) {
                                            outArray.push(JSON.parse(JSON.stringify(innerArray)));
                                            progessAc = progessAc.slice(index);
                                            var start = innerArray[0].begin;
                                            var end = progessAc[0].begin;
                                            innerArray = [];
                                            innerArray[0] = {
                                                begin: start,
                                                end: end,
                                                isOpacity: true
                                            };
                                            index = -1;
                                        } else {
                                            // innerArray.push(progessAc[index]);
                                            innerArray = innerArray.concat(getPauseList(progessAc[index]));
                                        }
                                    } else {
                                        if (toMinute(progessAc[index].begin) < toMinute(progessAc[index - 1].end)) {
                                            outArray.push(JSON.parse(JSON.stringify(innerArray)));
                                            progessAc = progessAc.slice(index);
                                            var start = innerArray[0].begin;
                                            var end = progessAc[0].begin;
                                            innerArray = [];
                                            innerArray[0] = {
                                                begin: start,
                                                end: end,
                                                isOpacity: true
                                            };
                                            index = -1;
                                        } else {
                                            // innerArray.push(progessAc[index]);
                                            innerArray = innerArray.concat(getPauseList(progessAc[index]));
                                            outArray.push(innerArray);
                                        };
                                    }
                                };
                                return outArray;
                            }
                        };
                        var renderGraphic = function (splitNum) {
                            var copyPauseReason = JSON.parse(JSON.stringify(data.Detail.pauseReason));
                            var optionGraphic = [];
                            var pauseReason = [];
                            for (var i = 0; i < Math.ceil(copyPauseReason.length / splitNum); i++) {
                                pauseReason.push(copyPauseReason.splice(0, splitNum));
                                i--;
                            };
                            var getGraphicTotal = function (array, start, init) {
                                if (array.length == 0) return 0;
                                var total = init; 
                                for (var i = start; i < array.length; i++ ) {
                                  total = total + array[0].children[0].shape.width;
                                }
                                return total;
                            };

                            pauseReason.forEach(function (item, index) {
                                item.forEach(function (innerItem, innerIndex) {
                                    var top = 5;
                                    var left = 15;
                                    var height = 30;
                                    var text = innerItem.code + ':' + innerItem.desc;

                                    var graphic = {
                                        type: 'group',
                                        left: left,
                                        top: top,
                                        children: [
                                            {
                                                type: 'rect',
                                                z: 100,
                                                top: 'center',
                                                left: 'center',
                                                shape: {
                                                    width: text.length * 13,
                                                    height: height
                                                },
                                                style: {
                                                    fill: innerItem.color,
                                                }
                                            },
                                            {
                                                type: 'text',
                                                top: 'middle',
                                                left: 'center',
                                                z: '100',
                                                style: {
                                                    text: text,
                                                    fontSize: 14,
                                                    fill: clorReverse(innerItem.color)
                                                }
                                            }
                                        ]
                                    }

                                    var graphicTotal = getGraphicTotal(optionGraphic, index * splitNum , 0);
                                    // console.log(graphicTotal)
                                    graphic.top = (top * (index + 1)) + (index * height);
                                    graphic.left = graphicTotal + (left * innerIndex);

                                    optionGraphic.push(graphic);
                                });
                            });
                            return optionGraphic;
                        }
                        var getMaxFunc = function (length) {
                          return function (value) {
                              var startTime = toMinute(startHour + ':00');
                              var currentMax = toMinute(data.Detail.bc_end) - startTime;
                              if ((value.max - (startMinute * length))  > currentMax)  {
                                return value.max
                              } else {
                                return currentMax
                              }
                          }
                        };

                        var option = {
                            grid: {
                                top: '120',
                                left: '0',
                                right: '3%',
                                bottom: '5%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'value',
                                maxInterval: 60,
                                min: startMinute,
                                max: '',
                                splitLine: {
                                    show: false,
                                },
                                axisLine: {
                                    lineStyle: {
                                        color: '#1D92B6',
                                    }
                                },
                                axisTick: {
                                    inside: true
                                },
                                axisLabel: {
                                    fontSize: '18',
                                    color: '#1D92B6',
                                    formatter: function (value, index) { 
                                        var startTime = toMinute(startHour + ':00');
                                      console.log(toMinuStr(startTime + 60 * index))
                                      console.log(value + '-' + index)
                                        if (index == 0) {
                                            return data.Detail.bc_begin
                                        } else {
                                          return toMinuStr(startTime + 60 * index)
                                        }
                                       
                                    }
                                }
                            },
                            yAxis: {
                                type: 'category',
                                inverse: true,
                                data: ['计划：', '实际：'],
                                axisLine: {
                                    show: false
                                },
                                axisTick: {
                                    show: false
                                },
                                axisLabel: {
                                    fontSize: '18',
                                    color: '#1D92B6',
                                    formatter: function (value) {
                                        var value = value != 'undefined' ? value : '';
                                        return value;
                                    }
                                }
                            },
                            series: [],
                            graphic: []
                        };

                        var totalTime = toMinute(data.Detail.bc_end) - toMinute(data.Detail.bc_begin);
                        var progessPArray = data.Detail.progessPlan;
                        var planArray = [];
                        progessPArray.forEach(function (item, index) {
                          if (index == 0 && (toMinute(item.begin) > toMinute(data.Detail.bc_begin))) {
                            planArray.push({
                              "wo": "",
                              "color": "transparent",
                              "planId": "",
                              "qty": "",
                              "planHour": 0,
                              "begin": data.Detail.bc_begin,
                              "end": item.begin
                            });
                          };
                          if (index && (toMinute(item.begin) > toMinute(progessPArray[index - 1].end))) {
                            planArray.push({
                              "wo": "",
                              "color": "transparent",
                              "planId": "",
                              "qty": "",
                              "planHour": 0,
                              "begin": progessPArray[index - 1].end,
                              "end": item.begin
                            });
                          }
                          planArray.push(item);
                        });
                        planArray.forEach(function (item) {
                            option.series.push({
                                stack: '总计划',
                                type: "bar",
                                label: {
                                    normal: {
                                        show: true,
                                        position: 'inside'
                                    }
                                },
                                data: [{
                                    value: toMinute(item.end) - toMinute(item.begin) + startMinute,
                                    label: {
                                        formatter: function () {
                                            return item.qty
                                        },
                                        offset: [0, 2],
                                        fontSize: '18',
                                        color: clorReverse(item.color),
                                        verticalAlign: 'middle'
                                    },
                                    itemStyle: {
                                        normal: {
                                            color: item.color
                                        }
                                    }
                                }]
                            })
                        });
                        if (data.Detail.progessAc.length > 0) {
                            var yAxisArray = getProgessAc();
                            var maxSeriesArray = [];
                            var maxSeries;
                            yAxisArray.forEach(function (item) {
                              maxSeriesArray.push(item.length);
                            });
                            maxSeries = Math.max.apply(null, maxSeriesArray);
                            if (maxSeries > option.series.length) {
                              var seriesLength = option.series.length;
                              for (var i = 0; i < maxSeries - seriesLength; i++) {
                                option.series.push({
                                    stack: '总计划',
                                    type: "bar",
                                    label: {
                                        normal: {
                                            show: true,
                                            position: 'inside'
                                        }
                                    },
                                    data: [{
                                        value: 0,
                                        label: {
                                            formatter: function () {
                                                return ''
                                            },
                                            offset: [0, 2],
                                            fontSize: '18',
                                            color: 'transparent',
                                            verticalAlign: 'middle'
                                        },
                                        itemStyle: {
                                            normal: {
                                                color: 'transparent'
                                            }
                                        }
                                    }]
                                })
                              }
                            };
                            if (yAxisArray.length >= 2) {
                                option.yAxis.data.length = yAxisArray.length + 1;
                            };
                            option.series.forEach(function (item, index) {
                                  for (let i = 0; i < yAxisArray.length; i++) {
                                      if (yAxisArray[i][index]) {
                                          if (yAxisArray[i][index].isOpacity) {
                                              item.data[i + 1] = {
                                                  value: toMinute(yAxisArray[i][index].end) - toMinute(yAxisArray[i][index].begin) + startMinute,
                                                  label: {
                                                      show: false
                                                  },
                                                  itemStyle: {
                                                      normal: {
                                                          color: 'transparent'
                                                      }
                                                  }
                                              }
                                          } else {
                                              var value = toMinute(yAxisArray[i][index].end) - toMinute(yAxisArray[i][index].begin) + startMinute;
                                              item.data[i + 1] = {
                                                  value: value,
                                                  label: {
                                                      formatter: function () {
                                                          return yAxisArray[i][index].qty
                                                      },
                                                      offset: [0, 2],
                                                      fontSize: value > 20 ? '16' : '12',
                                                      color: clorReverse(yAxisArray[i][index].color),
                                                      verticalAlign: 'middle'
                                                  },
                                                  itemStyle: {
                                                      normal: {
                                                          color: yAxisArray[i][index].color,
                                                          borderWidth: yAxisArray[i][index].IsOutTime ? '5' : '0',
                                                          borderColor: clorReverse(yAxisArray[i][index].color),
                                                      },
                                                      emphasis: {
                                                          borderWidth: yAxisArray[i][index].IsOutTime ? '5' : '0',
                                                          borderColor: clorReverse(yAxisArray[i][index].color),
                                                      }
                                                  }
                                              };
                                          }
                                      } else {
                                          item.data[i + 1] = '';
                                      };
                                }
                            });
                        };
                        option.xAxis.max = getMaxFunc(option.series.length);

                        var graphicNum = 12;
                        option.graphic = renderGraphic(graphicNum);
                        option.grid.top = Math.ceil(option.graphic.length / graphicNum) * 40;
                        this.graphicHeight = option.grid.top;              

                        this.myChart = echarts.init(myChart)
                        this.heightNum = option.series[0].data.length >= 2 ? option.series[0].data.length: 2;
                        this.$nextTick(function () {
                          that.myChart.resize()
                        });
                        console.log(option)
                        this.myChart.setOption(option);
                        var that = this;
                        window.onresize = function () {
                            that.myChart.resize()
                        }
                    }
                },
                mounted: function () {
                    this.getlinePanelInfo(getQueryString("workcenter"));
                },
                computed: {},
                filters: {
                    getPresent: function (price, fixPoint) {
                        if (!fixPoint) {
                            fixPoint = 2;
                        }
                        if (!price) return "0.00%";
                        price = (price * 100).toFixed(fixPoint);
                        var result = price.toString() + "%";
                        return result;
                    },
                },
                watch: {}
            })
        }
        function getQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]); return null;
        }
        var data = {
  "errcode": 0,
  "WC": [
      {
          "name": "压装",
          "code": "KC3A01YZ"
      },
      {
          "name": "中线",
          "code": "KC3A01ZX"
      },
      {
          "name": "小线",
          "code": "KC3A012XX"
      }
  ],
  "Detail": {
    "code": "KC3A01ZX",
    "bc_begin": "08:10",
    "bc_end": "18:00",
    "title": {
        "wocount": 10,
        "wocount_ac": 5,
        "qty": 44,
        "qty_ac": 10,
        "totalHour": 19.27,
        "totalHour_ac": 12.02
    },
    "details": [
        {
            "PlanDate": "2019-08-26",
            "WO": "0000273591",
            "Stock": "30851601525|泵NP3085SH254 2.4KW50HZ3P",
            "BeginTime": "08:35:02",
            "EndTime": "09:31:04",
            "PlanHour": 0.48,
            "AcHour": 0.4,
            "IsOutTime": false,
            "PlanQty": 1,
            "AcQty": 1,
            "StatusCode": 3,
            "Status": "已完成",
            "Remark": ""
        },
        {
            "PlanDate": "2019-08-26",
            "WO": "0000273594",
            "Stock": "30851600031|泵NP3085MT460 2KW50HZ3P",
            "BeginTime": "08:35:13",
            "EndTime": "09:47:37",
            "PlanHour": 0.96,
            "AcHour": 1.44,
            "IsOutTime": true,
            "PlanQty": 2,
            "AcQty": 2,
            "StatusCode": 3,
            "Status": "已完成",
            "Remark": "其他"
        },
        {
            "PlanDate": "2019-08-26",
            "WO": "0000273715",
            "Stock": "30851601873|泵NZ3085SH253 2.4KW50HZ3P",
            "BeginTime": "09:00:45",
            "EndTime": "10:28:00",
            "PlanHour": 0.93,
            "AcHour": 1.35,
            "IsOutTime": true,
            "PlanQty": 2,
            "AcQty": 2,
            "StatusCode": 3,
            "Status": "已完成",
            "Remark": "其他"
        },
        {
            "PlanDate": "2019-08-26",
            "WO": "0000273599",
            "Stock": "30851602164|泵NP3085SH256 2.4KW50HZ3P",
            "BeginTime": "09:34:47",
            "EndTime": "12:46:03",
            "PlanHour": 1.4,
            "AcHour": 3.09,
            "IsOutTime": true,
            "PlanQty": 3,
            "AcQty": 3,
            "StatusCode": 3,
            "Status": "已完成",
            "Remark": "其他"
        },
        {
            "PlanDate": "2019-08-26",
            "WO": "0000273600",
            "Stock": "30851601610|泵NP3085SH256 2.4KW50HZ3P",
            "BeginTime": "10:26:26",
            "EndTime": "11:41:57",
            "PlanHour": 0.96,
            "AcHour": 1.2,
            "IsOutTime": true,
            "PlanQty": 2,
            "AcQty": 2,
            "StatusCode": 3,
            "Status": "已完成",
            "Remark": "其他"
        },
        {
            "PlanDate": "2019-08-26",
            "WO": "0000268336",
            "Stock": "13151810006|泵K 1315SH261 4.4KW50HZ",
            "BeginTime": "10:53:04",
            "EndTime": "00:00:00",
            "PlanHour": 7.2,
            "AcHour": 4.54,
            "IsOutTime": false,
            "PlanQty": 18,
            "AcQty": 0,
            "StatusCode": 2,
            "Status": "生产中",
            "Remark": ""
        },
        {
            "PlanDate": "2019-08-26",
            "WO": "0000272714",
            "Stock": "13151810303|泵K1315SH262 4.4KW50HZ3PH",
            "BeginTime": "00:00:00",
            "EndTime": "00:00:00",
            "PlanHour": 3.2,
            "AcHour": 0,
            "IsOutTime": false,
            "PlanQty": 8,
            "AcQty": 0,
            "StatusCode": 1,
            "Status": "待生产",
            "Remark": ""
        },
        {
            "PlanDate": "2019-08-26",
            "WO": "0000273598",
            "Stock": "13151810471|泵K1315MT423 1.8KW50HZ",
            "BeginTime": "00:00:00",
            "EndTime": "00:00:00",
            "PlanHour": 0.87,
            "AcHour": 0,
            "IsOutTime": false,
            "PlanQty": 2,
            "AcQty": 0,
            "StatusCode": 1,
            "Status": "待生产",
            "Remark": ""
        },
        {
            "PlanDate": "2019-08-26",
            "WO": "0000273603",
            "Stock": "13151810471|泵K1315MT423 1.8KW50HZ",
            "BeginTime": "00:00:00",
            "EndTime": "00:00:00",
            "PlanHour": 0.87,
            "AcHour": 0,
            "IsOutTime": false,
            "PlanQty": 2,
            "AcQty": 0,
            "StatusCode": 1,
            "Status": "待生产",
            "Remark": ""
        },
        {
            "PlanDate": "2019-08-26",
            "WO": "0000268337",
            "Stock": "31271700138|泵MP3127LT210,7.4KW50HZ3P",
            "BeginTime": "00:00:00",
            "EndTime": "00:00:00",
            "PlanHour": 2.4,
            "AcHour": 0,
            "IsOutTime": false,
            "PlanQty": 4,
            "AcQty": 0,
            "StatusCode": 1,
            "Status": "待生产",
            "Remark": ""
        }
    ],
    "progessPlan": [
        {
            "wo": "0000273591",
            "color": "#990033",
            "planId": "WK0700006380",
            "qty": 1,
            "planHour": 11.52,
            "begin": "08:10",
            "end": "08:20"
        },
        {
            "wo": "0000273715",
            "color": "#cc9999",
            "planId": "WK0700006384",
            "qty": 2,
            "planHour": 22.42,
            "begin": "08:20",
            "end": "08:56"
        },
        {
            "wo": "0000273599",
            "color": "#ffcc99",
            "planId": "WK0700006386",
            "qty": 3,
            "planHour": 33.626666666666666666666666667,
            "begin": "08:56",
            "end": "09:29"
        },
        {
            "wo": "0000273600",
            "color": "#ffff00",
            "planId": "WK0700006388",
            "qty": 2,
            "planHour": 23.04,
            "begin": "09:29",
            "end": "09:52"
        },
        {
            "wo": "0000268336",
            "color": "#cc9966",
            "planId": "WK0700006390",
            "qty": 18,
            "planHour": 172.8,
            "begin": "09:52",
            "end": "10:00"
        },
        {
            "wo": "0000268336",
            "color": "#cc9966",
            "planId": "WK0700006390",
            "qty": 18,
            "planHour": 172.8,
            "begin": "10:15",
            "end": "12:59"
        },
        {
            "wo": "0000272714",
            "color": "#cccc00",
            "planId": "WK0700006392",
            "qty": 8,
            "planHour": 76.8,
            "begin": "12:59",
            "end": "14:55"
        },
        {
            "wo": "0000273598",
            "color": "#ffcccc",
            "planId": "WK0700006394",
            "qty": 2,
            "planHour": 20.806666666666666666666666667,
            "begin": "14:55",
            "end": "15:00"
        },
        {
            "wo": "0000273598",
            "color": "#ffcccc",
            "planId": "WK0700006394",
            "qty": 2,
            "planHour": 20.806666666666666666666666667,
            "begin": "15:15",
            "end": "15:30"
        },
        {
            "wo": "0000273603",
            "color": "#990033",
            "planId": "WK0700006396",
            "qty": 2,
            "planHour": 20.806666666666666666666666667,
            "begin": "15:30",
            "end": "15:50"
        },
        {
            "wo": "0000268337",
            "color": "#cccc00",
            "planId": "WK0700006398",
            "qty": 4,
            "planHour": 57.6,
            "begin": "15:50",
            "end": "16:47"
        }
    ],
    "progessAc": [
        {
            "wo": "0000273591",
            "color": "#990033",
            "begin": "08:35",
            "end": "09:31",
            "qty": 1,
            "IsOutTime": false,
            "pauseList": []
        },
        {
            "wo": "0000273594",
            "color": "#ffcc99",
            "begin": "08:35",
            "end": "09:47",
            "qty": 2,
            "IsOutTime": true,
            "pauseList": []
        },
        {
            "wo": "0000273715",
            "color": "#cc9999",
            "begin": "09:00",
            "end": "10:28",
            "qty": 2,
            "IsOutTime": true,
            "pauseList": []
        },
        // {
        //     "wo": "0000273599",
        //     "color": "#ffcc99",
        //     "begin": "09:34",
        //     "end": "12:46",
        //     "qty": 3,
        //     "IsOutTime": true,
        //     "pauseList": []
        // },
        // {
        //     "wo": "0000273600",
        //     "color": "#ffff00",
        //     "begin": "10:26",
        //     "end": "11:41",
        //     "qty": 2,
        //     "IsOutTime": true,
        //     "pauseList": []
        // },
        // {
        //     "wo": "0000268336",
        //     "color": "#cc9966",
        //     "begin": "10:53",
        //     "end": "13:13",
        //     "qty": 0,
        //     "IsOutTime": false,
        //     "pauseList": []
        // }
    ],
    "pauseReason": [
        {
            "code": "R1",
            "desc": "无暂停",
            "color": "#000000"
        },
    ]
}
}
    </script>
</body>

</html>
